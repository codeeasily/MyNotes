复制是指将主库的DDL和DML操作通过二进制日志传到复制服务器（也叫从库）上，然后在从库上对这些日志重新执行（也叫重做），从而使得从库和主库的数据保持同步。

MySQL支持一台主库同时向多台从库进行复制，从库同时也可以作为其他服务器的主库，实现链状的复制。

# 复制的优点：
- 如果主库出问题，可以快速切换到从库提供服务
- 可以在从库上执行查询操作，降低主库的访问压力
- 可以在从库上执行备份，避免备份期间影响主库的服务

> 由于MySQL实现的是异步的复制，所以主从库之间存在一定的差距，在从库上进行的查询操作要考虑到这些数据的差异，一般只有更新不频繁的数据或对实时性要求不高的数据可以通过从库查询，
> 实时性要求高的数据仍然需要从主库获得。

# 复制的原理
1. 首先，MySQL主库在事务提交时会把数据变更作为时间Events记录在二进制日志文件Binlog中；MySQL主库上的sync_binlog参数控制Binlog日志刷新到磁盘。
2. 主库推送二进制日志文件Binlog中的事件到从库的中继日志Relay Log，之后从库根据中继日志Relay Log重做数据变更操作，通过逻辑复制以此来达到从库和主库的数据一致。

MySQL通过3个线程来完成主从库间的数据复制：其中Binlog Dump线程跑在主库上，I/O线程和SQL线程跑在从库上。
当在从库上启动复制时，首先创建I/O线程连接主库，主库随后创建Binlog Dump线程读取数据库事件并发送给I/O线程，I/O线程获取到事件数据后更新到从库的中继日志Relay Log中去，
之后从库上的SQL线程读取中继日志Relay Log中更新的数据库事件并应用。

可以通过SHOW PROCESSLIST命令在主库上查看Binlog Dump线程，也可以在从库上看到I/O线程和SQL线程。

# 复制中的各类文件
## 二进制日志文件（Binlog）：
会把MySQL中的所有数据修改操作以二进制的形式记录到日志文件中，包括Create、Drop、Insert、Update、Delete操作等，不记录select；
  > 可以通过 `show variables`查看Binlog的格式
  > ```sql
  > mysql> show variables like '%binlog_format'
  > ```
  > Binlog支持Statement、Row、Mixed三种格式，对应MySQL的3中复制技术。
## 中继日志文件（Relay Log）
文件格式、内容和二进制日志文件（Binlog）一样。唯一的区别在于从库上的SQL线程在执行完当前中继日志文件Relay Log中的事件之后，SQL线程会自动删除当前中继日志文件Relay Log，避免从库上的中继日志文件Relay Log占用过多的磁盘空间。

为了保证从库Crash重启之后，从库的I/O线程和SQL线程仍然能知道从哪里开始复制，从库上默认会创建两个日志文件master.info和relay-log.info用来保存复制的进度。

# 三种复制方式
二进制日志文件Binlog的格式有以下三种：
- Statement：基于SQL语句级别的Binlog，每条修改数据的SQL都会保存到Binlog里
- Row：基于行级别的，记录每一行数据的变化。也就是将每行数据的变化都记录来到Binlog里面，记录的非常详细，但并不记录原始SQL；
  > 在复制的时候并不会因为存储过程或触发器造成主从库数据不一致问题，但是记录的日志量较Statement格式要大得多。
- Mixed：混合Statement和Row模式，默认情况下采用Statement模式记录，某些情况下会切换到Row模式，例如SQL中包含与时间、用户相关的函数等。  

对应MySQL复制的三种技术：
- binlog_format=Statement：基于SQL语句的复制，也叫Statement-Based Replication（SBR），MySQL5.1.4或之前版本仅提供基于SQL语句的复制；
- binlog_format=ROW：基于行的复制，也叫Row-Based Replication（RBR）。
- binlog_format=Mixed：混合复制模式，混合了基于SQL语句的复制和基于行的复制。

> MySQL 5.1.11和之前版本，5.1.29和之后的版本，默认设置是基于SQL语句的复制
> 只有MySQL 5.1.12到5.1.28之间的版本默认基于混合模式
# 复制的3中常见架构
1. 一主多从复制架构
  > 主库读取请求压力非常大的场景，可以通过一主多从实现读写分离，降低主库的读取压力。 
2. 多级复制架构
  > 一主多从能解决大部分读取请求压力特别大的场景的需求，考虑到MySQL复制是推送Binlog日志到从库，主库的I/O压力和网络压力会随着从库的增加而增长（每个从库都会在主库上有一个独立的Binlog Dump线程来发送事件），而多级复制架构解决了一主多从场景下，主库额外的I/O和网络压力。
  >
  > 仅仅是在一主多从基础上增加二级主库，主库给二级主库推送Binlog日志，由二级主库负责推送Binlog日志给从库。
  >
  > 缺点是，延时比一主多从复制场景的要高。
  > 
  > 可以在二级主库上选择表引擎为BLACKHOLE来降低多级复制的延时，BLACKHOLE引擎写入表的数据不会写回到磁盘上，永远是一个空表，INSERT/UPDATE/DELETE操作仅仅在Binlog中记录事件。
3. 双主复制/DUAL MASTER架构
特别适用于DBA做维护等需要主从切换的场景，通过双主/DUAL MASTER架构避免了重复搭建从库的麻烦。

可以大大减轻一主多从架构下对主库进行维护带来的额外搭建从库的工作。

# 半同步复制
MySQL5.5之前的复制是异步复制，从库和从库的数据之间存在一定的延迟。这样有一个隐患：当主库写入一个事务并提交成功，而从库未得到主库推送的Binlog日志时，主库宕机了，例如主库可能因为磁盘损坏、内存故障等造成主库上该事务的Binlog丢失，此时从库就可能损失这个事务，从而造成主从不一致。

为了解决这个问题，MySQL5.5引入了

